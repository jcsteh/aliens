<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Aliens</title>
<style>
	#status {
		text-align: center;
		font-weight: bold;
		font-size: xx-large;
		transition: opacity 200ms;
	}
	#nextLevel {
		position: absolute;
		top: 30vh;
		width: 100vw;
		text-align: center;
		font-size: 1000%;
		font-weight: bold;
		transition: opacity 200ms;
	}
	#scoreContainer {
		text-align: center;
		font-weight: bold;
		font-size: xxx-large;
	}
	#visual {
		height: 60%;
		display: flex;
		position: relative;
		border: none;
	}
	.cell {
		flex: 1;
		height: 100%;
		border: solid;
	}
	.entity {
		display: block;
		position: absolute; /* Relative to #visual */
		text-align: center;
		font-size: x-large;
		transition: left 20ms, opacity 20ms;
	}
	.hidden {
		opacity: 0%;
	}
</style>
</head>
<body>
<h1>Aliens</h1>
<div id="intro">
	<p>Copyright 2025 James Teh, based on the Eureka A4 game by Geoff Shang</p>
	<p>Version 23</p>
	<p>
		You will first hear your position, represented by a pitched beep.
		When an alien arrives, you will hear a second beep.
		The beeps alternate between your position and the position of any aliens.
	</p>
	<p>
		Move your position left or right with the left or right arrow keys to match the pitch of the alien.
		Press space to fire before they hit the ground and destroy you!
		If you are using a touch screen, tap the left of the screen to move left, the right of the screen to move right and the centre to fire.
		If you are using a touch screen reader, you will need to turn it off after starting the game so the game can receive the taps directly.
		For either keyboard or touch screen, You can hold your finger down to move faster.
	</p>
	<p>
		Most aliens remain stationary.
		However, you will occasionally encounter commanders which move from left to right, increasing in pitch.
		You don't lose a life if you don't hit a commander, but you get bonus points if you do.
	</p>
	<p>
		As you level up, you must confront more aliens at once and you will encounter more commanders.
		In the higher levels, the game will speed up.
	</p>
	<p>If you are using a screen reader, you can announce your score at any time during the game by pressing s.</p>
	<p>Every 200 points, you can gain an extra life, but only up to a maximum of 5 lives.</p>
	<p>If you are using an iPhone on speaker, ensure your phone is not set to silent.</p>
	<button id="start" disabled onclick="start();">Start</button>
</div>
<div id="game" role="application" tabindex="-1" aria-labelledby="status"
		style="width: 100vw; height: 90vh;" hidden>
	<div id="status"></div>
	<div id="nextLevel" class="hidden" aria-hidden="true"></div>
	<div id="scoreContainer">Score: <span id="score"></span></div>
	<div style="height: 30%; display: flex;">
		<button id="left" style="flex: 1; height: 100%;">‚Üê</button>
		<button id="fire" style="flex: 1; height: 100%;">üî•</button>
		<button id="right" style="flex: 1; height: 100%;">‚Üí</button>
	</div>
	<div id="visual"></div>
</div>
<div id="gameOver" role="dialog" tabindex="-1" aria-label="Game Over" hidden>
	<p id="gameOverMessage"></p>
	<button id="startAgain" onclick="start();">Start again</button>
</div>
<div id="announce" aria-live="polite"
	style="position: absolute; left: -10000px;"></div>

<script>
const BASE_LENGTH = 0.1; // The starting length of beeps.
// How much the length decreases each level.
const LEVEL_LENGTH_DECREMENT = 0.010;
// Minimum number of ticks to wait between aliens.
const MIN_ALIEN_WAITS = 8;
const MAX_ALIEN_WAITS = 18;
const ALIEN_TRIES = 30; // How many ticks the player has to hit the alien.
const MAX_LIVES = 5;
const POINTS_FOR_NEW_LIFE = 200;
const BASE_FREQ = 130.8; // C2
const MIN_NOTE = 0; // C3
const MAX_NOTE = 18; // C6; each note is a whole tone
const FADE_LENGTH = 0.010; // The length of audio fades to prevent clicks.

const audioCtx = new AudioContext();
const masterVol = new GainNode(audioCtx, { gain: 0.3 } );
masterVol.connect(audioCtx.destination);
const samples = {}; // Map of sample names to audio buffers.
let playingFireSample; // Last played fire sample (might still be playing).
let pendingTick = null; // Timeout id for the next tick.
// Timeout id for triggering continual movement via a touch screen.
let continualTouchTimer = null;
// Function to call for continual touch movement.
let continualTouchDir = null;

// Values taken from https://github.com/GoogleChromeLabs/web-audio-samples/tree/main/archive/demos/wave-tables
// Trombone
const wave1 = audioCtx.createPeriodicWave(
	new Float32Array([0,0.171738,0.131907,-0.1948,-0.129913,-0.081043,0.049213,0.027828,-0.008357,-0.005044,0.002145,0.000773,-0.001392,-0.000916,-0.000012,0.000323,-0.000003,0.000127,-0.000135,-0.000029,-0.000031,0.000087,-0.000091,0.000005,-0.000026,0.000027,-0.000062,-0.000017,-0.000002,0.000002,0.000012,-0.000024,0.000011,-0.000011,-0.000001,0,0.000003,0.000006,-0.000009,-0.000002,0.000001,0.000007,0.000014,-0.000008,-0.000001,-0.000003,-0.000011,-0.000003,0.000004,-0.000002,-0.000004,0.000001,-0.000004,0.000001,0.000003,0.000001,0.000002,0.000003,-0.000001,-0.000005,0,0.000001,-0.000008,0.000001,0.000003,-0.000004,-0.000004,-0.000002,0.000003,0,-0.000002,-0.000009,0.000009,0.000024,0.000011,-0.000017,-0.000024,-0.000002,0,0.000002,0.000015,0.000022,0.000001,-0.000022,-0.000016,0.000001,0.000002,-0.000003,-0.000002,0.000001,-0.000001,0.000005,0.000001,-0.000001,-0.000001,0,-0.000001,-0.000003,-0.000001,-0.000002,0.000001,-0.000003,-0.000002,0.000004,0.000007,-0.000002,-0.000006,-0.000009,-0.000003,-0.000001,0.000001,0,0.000006,0,-0.000009,-0.000011,0.000003,0.000005,-0.000002,-0.000002,-0.000001,0.000001,0.000001,0,-0.000001,-0.000001,0.000001,0,-0.000001,0.000002,0.000001,0,0,0,-0.000001,0,0,-0.000002,-0.000001,0,0,0,0.000001,0.000001,-0.000001,-0.000001,-0.000002,0.000001,0.000002,-0.000001,-0.000004,0,0.000004,0.000005,0.000001,0,-0.000002,0,-0.000004,0.000001,0.000004,0.000007,0,-0.000004,0,0.000002,0.000001,-0.000001,0.000001,0,0,-0.000001,0,-0.000002,0.000001,0.000004,0,-0.000007,0.000002,0.00003,0.000007,-0.000035,0.000007,0.000111,0.000036,-0.000022,-0.000053,0,0.000001,-0.000004,0.000035,0.000082,0.00004,-0.000032,-0.000062,-0.000012,0.000012,-0.000008,-0.000006,0.000004,0.000006,0.000003,0.000001,0,0.000001,0,0,-0.000001,-0.000001,-0.000001,-0.000001,-0.000002,-0.000002,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,-0.000001,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),
	new Float32Array([0,-0.090905,0.482287,0.259485,0.009402,-0.125271,-0.046816,0.007872,0.001762,-0.010488,-0.002305,0.001791,0.001101,-0.000303,-0.000064,0.000143,0.000059,0.000116,0.00012,-0.000011,-0.000066,-0.000019,0.000024,0.000014,0.000069,0.000056,0.000005,0.000002,-0.000026,-0.000015,0.000055,0.000012,0.000046,-0.000007,0.000007,-0.000003,-0.000007,0.000002,-0.000003,-0.00001,-0.000011,-0.000004,0.000003,0.000001,0.000005,-0.000001,-0.000004,0.000001,0.000001,0.000001,0.000004,0,-0.000001,0.000001,0.000004,-0.000001,-0.000002,0,-0.000003,-0.000004,0.000003,-0.000007,0,0.000001,0.000003,0.000002,0,-0.000001,0,0.000001,0.000006,-0.000008,-0.000016,0.000013,0.000017,0.000013,0.000001,0,-0.000002,-0.000001,-0.000004,0.000007,0.000016,0.000021,-0.000008,-0.000013,0.000003,0.000006,-0.000001,0.000001,0.000002,0,0.000001,-0.000001,0.000001,0,0,-0.000004,0.000002,0,0.000001,0.000002,-0.000001,-0.000005,0.000004,0.000014,0.000005,-0.000006,-0.000007,-0.000001,-0.000001,0,0.000009,0.000009,0.000001,-0.000006,-0.000008,0.000001,0.000002,-0.000001,-0.000002,0,0.000001,0.000001,0,0,0.000002,-0.000002,0,-0.000001,0,0,-0.000001,-0.000001,0,0,0.000001,0,0,-0.000001,0,0,0,0,0.000001,0.000001,-0.000002,-0.000003,-0.000001,0.000002,-0.000001,-0.000007,-0.000002,0.000002,0.000004,0,0.000001,0.000001,-0.000002,-0.000006,-0.000002,0.000003,0.000006,0.000001,0,0,0.000002,-0.000001,-0.000001,-0.000001,0.000001,0,0,-0.000001,0,0.000003,0.000008,0.000001,-0.00001,-0.000006,0.000015,-0.000026,-0.000075,-0.00001,0.00005,0.000082,0.000023,-0.000004,0,-0.000002,-0.000045,-0.000002,0.000041,0.000093,-0.000009,-0.000034,0.000008,0.00002,-0.000001,-0.000006,-0.000001,0,-0.000002,-0.000004,-0.000003,-0.000003,-0.000002,-0.000003,-0.000002,-0.000002,-0.000002,-0.000001,-0.000001,-0.000001,-0.000001,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])
);
// Piano
const wave2 = audioCtx.createPeriodicWave(
	new Float32Array([0,0,-0.203569,0.5,-0.401676,0.137128,-0.104117,0.115965,-0.004413,0.067884,-0.00888,0.0793,-0.038756,0.011882,-0.030883,0.027608,-0.013429,0.00393,-0.014029,0.00972,-0.007653,0.007866,-0.032029,0.046127,-0.024155,0.023095,-0.005522,0.004511,-0.003593,0.011248,-0.004919,0.008505,-0.00292,0.00152,-0.005641,0.002615,-0.001866,0.001316,-0.00032,0.0008,-0.000957,0.001989,-0.001172,0.001682,-0.00262,0.000544,-0.000734,0.000186,-0.000363,0.000243,-0.000142,0.000437,-0.00086,0.000117,-0.00035,0.00011,-0.000253,0.000218,-0.000061,0.000015,-0.000038,0.000017,-0.000025,0.000007,-0.000081,0.000017,-0.000064,0.000166,-0.000009,0.000013,-0.000024,0.000001,-0.000032,0.000013,-0.000018,0.000007,-0.000013,0.00001,-0.000023,0.000008,-0.000025,0.000046,-0.000035,0.000006,-0.000012,0.000012,-0.000024,0.000023,-0.000024,0.000027,-0.00001,0.000022,-0.000011,0.000021,-0.000007,0.000011,-0.000006,0.000021,-0.000014,0.000026,-0.000013,0.000003,-0.000032,0.000033,-0.000036,0.000025,-0.00002,0.000026,-0.00005,0.000028,-0.000013,0.000008,-0.000018,0.00002,-0.000086,0.00012,-0.000005,0.000012,-0.000016,0.000028,-0.000012,0.000006,-0.000015,0.000012,-0.000022,0.000012,-0.000023,0.000024,-0.000011,0.000022,-0.000009,0.000018,-0.000019,0.000013,-0.000042,0.000015,-0.000019,0.000014,-0.000019,0.000007,-0.000008,0.00003,-0.000011,0.000011,-0.000012,0.000022,-0.000007,0.000018,-0.000028,0.000025,-0.00002,0.000008,-0.000032,0.000022,-0.00001,0.000013,-0.000026,0.000013,-0.000024,0.000009,-0.000107,0.000109,-0.000007,0.000014,-0.000015,0.000007,-0.000029,0.000045,-0.000023,0.000039,-0.00001,0.000029,-0.000008,0.000036,-0.000018,0.000007,-0.000007,0.000007,-0.000025,0.00001,-0.000006,0.000022,-0.000021,0.000007,-0.000018,0.000011,-0.000011,0.00001,-0.000015,0.00002,-0.000012,0.000004,-0.000005,0.000007,-0.000007,0.000003,-0.000001,0.000006,-0.000007,0.000018,-0.000002,0.000005,-0.000008,0.000006,-0.00001,0.000016,-0.00001,0.000021,-0.000011,0.000013,-0.000011,0.000005,-0.000006,0.000016,-0.000014,0.000014,-0.000009,0.000009,-0.000004,0.000013,-0.000015,0.000004,-0.000007,0.000007,-0.000004,0.000004,-0.000009,0.00001,-0.000008,0.000013,-0.000012,0.000001,-0.000003,0.000012,-0.000004,0.000004,-0.000007,0.000008,-0.00001,0.000013,-0.000015,0.000013,-0.00001,0.000012,-0.000008,0.000011,-0.000024,0.000008,-0.000013,0.000013,-0.000018,0.000005,-0.000022,0.000037,-0.000019,0.000027,-0.000022,0.000026,-0.000029,0.000029,-0.000029,0.000031,-0.000034,0.000032,-0.000031,0.000037,-0.000033,0.000038,-0.000038,0.000039,-0.000036,0.000035,-0.000038,0.000035,-0.000034,0.000033,-0.00003,0.000029,-0.000028,0.000025,-0.000023,0.000022,-0.00002,0.000018,-0.000017,0.000015,-0.000014,0.000013,-0.000012,0.000011,-0.000011,0.00001,-0.000009,0.000009,-0.000009,0.000008,-0.000008,0.000008,-0.000008,0.000007,-0.000007,0.000007,-0.000007,0.000006,-0.000006,0.000006,-0.000006,0.000006,-0.000005,0.000006,-0.000006,0.000005,-0.000005,0.000005,-0.000005,0.000005,-0.000005,0.000005,-0.000005,0.000004,-0.000004,0.000004,-0.000005,0.000004,-0.000004,0.000004,-0.000004,0.000004,-0.000004,0.000004,-0.000004,0.000004,-0.000003,0.000004,-0.000004,0.000003,-0.000003,0.000003,-0.000004,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000002,0.000003,-0.000003,0.000003,-0.000002,0.000003,-0.000003,0.000002,-0.000002,0.000002,-0.000003,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000001,0.000002,-0.000002,0.000002,-0.000001,0.000002,-0.000002,0.000002,-0.000001,0.000002,-0.000002,0.000001,-0.000001,0.000002,-0.000002,0.000001,-0.000001,0.000001,-0.000002,0.000001,-0.000001,0.000001,-0.000002,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0,0,0.000001,-0.000001,0,0,0,-0.000001,0,0,0,-0.000001,0,0,0,-0.000001,0,0,0,-0.000001,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),
	new Float32Array([0,0.147621,-0.000001,0.000007,-0.00001,0.000005,-0.000006,0.000009,0,0.000008,-0.000001,0.000014,-0.000008,0.000003,-0.000009,0.000009,-0.000005,0.000002,-0.000007,0.000005,-0.000005,0.000005,-0.000023,0.000037,-0.000021,0.000022,-0.000006,0.000005,-0.000004,0.000014,-0.000007,0.000012,-0.000004,0.000002,-0.00001,0.000005,-0.000004,0.000003,-0.000001,0.000002,-0.000002,0.000005,-0.000003,0.000005,-0.000008,0.000002,-0.000002,0.000001,-0.000001,0.000001,-0.000001,0.000002,-0.000003,0,-0.000002,0,-0.000001,0.000001,0,0,0,0,0,0,0,0,0,0.000001,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.000001,-0.000001,0,0,0,-0.000001,0,0,0,0,0,-0.000002,0.000002,0,0,0,0.000001,0,0,0,0,0,0,-0.000001,0.000001,0,0.000001,0,0,-0.000001,0,-0.000001,0,-0.000001,0,-0.000001,0,0,0.000001,0,0,0,0.000001,0,0.000001,-0.000001,0.000001,-0.000001,0,-0.000001,0.000001,0,0,-0.000001,0,-0.000001,0,-0.000004,0.000004,0,0.000001,-0.000001,0,-0.000001,0.000002,-0.000001,0.000002,0,0.000001,0,0.000002,-0.000001,0,0,0,-0.000001,0,0,0.000001,-0.000001,0,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0,0,0,0,0,0,0,0,0.000001,0,0,0,0,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0,0,0.000001,-0.000001,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0,-0.000001,0,0,0,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0,0,0.000001,0,0,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000002,0.000001,-0.000001,0.000001,-0.000002,0,-0.000002,0.000004,-0.000002,0.000003,-0.000002,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000004,-0.000004,0.000004,-0.000004,0.000004,-0.000004,0.000004,-0.000004,0.000004,-0.000004,0.000004,-0.000003,0.000003,-0.000003,0.000003,-0.000003,0.000003,-0.000002,0.000002,-0.000002,0.000002,-0.000002,0.000002,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0.000001,0,0.000001,-0.000001,0,0,0.000001,-0.000001,0,0,0,-0.000001,0,0,0,-0.000001,0,0,0,-0.000001,0,0,0,-0.000001,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])
);

// The length of beeps. Determines the speed of the game.
let length;
let level;
let requiredHits; // The number of hits required this level.
let maxAliens; // The maximum number of simultaneous aliens this level.
// The maximum number of commanders that can be encountered this level.
let maxCommanders;
let hits; // The number of hits the player achieved this level.
let commanders; // The number of commanders encountered so far this level.
let points;
let lives;
let totalShipsHit;
let totalCommandersHit;

const introArea = document.getElementById("intro");
const startButton = document.getElementById("start");
const gameArea = document.getElementById("game");
const statusArea = document.getElementById("status");
const scoreArea = document.getElementById("score");
const nextLevelArea = document.getElementById("nextLevel");
const leftButton = document.getElementById("left");
const rightButton = document.getElementById("right");
const fireButton = document.getElementById("fire");
const visualArea = document.getElementById("visual");
const gameOverArea = document.getElementById("gameOver");
const gameOverMessageArea = document.getElementById("gameOverMessage");
const startAgainButton = document.getElementById("startAgain");
const announceArea = document.getElementById("announce");

async function loadSample(name) {
	const response = await fetch(`${name}.mp3`);
	const arrayBuffer = await response.arrayBuffer();
	const buffer = await audioCtx.decodeAudioData(arrayBuffer);
	samples[name] = buffer;
	return buffer;
}

function playSample(name, options={
	delay: 0,
	pan: 0,
}) {
	const source = new AudioBufferSourceNode(audioCtx,
		{ buffer: samples[name] });
	let dest;
	if (options.pan) {
		dest = new StereoPannerNode(audioCtx, { pan: options.pan });
		dest.connect(masterVol);
	} else {
		dest = masterVol;
	}
	source.connect(dest);
	source.start(audioCtx.currentTime + options.delay);
	const promise = new Promise(resolve => {
		source.addEventListener("ended", () => resolve());
	});
	promise.stop = source.stop.bind(source);
	return promise;
}

class Entity {
	constructor() {
		this.oscWave = wave1;
		this.audioDest = masterVol;
		this.visualNode = document.createElement("div");
		this.visualNode.className = "entity";
		this.visualNode.textContent = "üöÄ";
		this.visualNode.style.top = "85%";
	}

	set note(note) {
		this._note = note;
		// Whole-tone scale from our base frequency.
		this.freq = BASE_FREQ * 2 ** (note / 6);
		// Visually, we want to smoothly transition from cell to cell. If we made
		// this.visualNode a child of a cell, we'd need to move it in the DOM when it
		// moves to a new cell, which would mean we can't use CSS transitions and
		// would thus result in flashing. Instead, make it an absolutely positioned
		// child of visualArea.
		if (!this.visualNode.isConnected) {
			visualArea.append(this.visualNode);
		}
		// We have to calculate the cell's position relative to visualArea.
		const cellWidth = 100 / (MAX_NOTE + 1);
		this.visualNode.style.left = `${cellWidth * this.note}%`;
		// Set the width to 1 cell so we can centre the content.
		this.visualNode.style.width = `${cellWidth}%`;
	}

	get note() {
		return this._note;
	}

	play(freq) {
		const start = audioCtx.currentTime;
		const end = start + length;
		// Fade out the beep a little to prevent clicks.
		const gain = new GainNode(audioCtx, { gain: 1 });
		gain.connect(this.audioDest);
		gain.gain.exponentialRampToValueAtTime(1, end - FADE_LENGTH);
		gain.gain.exponentialRampToValueAtTime(0.01, end);
		this.osc = new OscillatorNode(audioCtx, { frequency: freq });
		this.osc.setPeriodicWave(this.oscWave);
		this.osc.connect(gain);
		this.osc.start();
		this.osc.stop(end);
	}

	down(amount=1) {
		this.note = Math.max(this._note - amount, MIN_NOTE);
	}

	up(amount=1) {
		this.note = Math.min(this._note + amount, MAX_NOTE);
	}

	tick() {
		this.play(this.freq);
	}
}

class Alien extends Entity {
	constructor(pan) {
		super();
		this.oscWave = wave2;
		this.pan = pan;
		this.audioDest = new StereoPannerNode(audioCtx, { pan: pan });
		this.audioDest.connect(masterVol);
		this.ticks = 0;
	}

	reset() {
		// Wait a random number of ticks before appearing.
		let ticks = -(MIN_ALIEN_WAITS + Math.round(Math.random() *
			(MAX_ALIEN_WAITS - MIN_ALIEN_WAITS)));
		// Don't let two aliens appear too close together in time.
		if (willAlienAppearNear(ticks)) {
			this.ticks = getFurthestWaitingAlienTicks() - MIN_ALIEN_WAITS;
		} else {
			this.ticks = ticks;
		}
		// Randomly bring in a commander, but only if there isn't one already and we
		// haven't reached maxCommanders.
		this.isCommander = commanders < maxCommanders && !hasActiveCommander() &&
			Math.round(Math.random());
		if (this.isCommander) {
			++commanders;
			// Commanders start from the bottom and move up.
			this.note = 0;
		} else {
			this.note = Math.floor(Math.random() * MAX_NOTE);
		}
		this.visualNode.textContent = "üõ∏";
		// We want the alien to return to the top immediately, ready for its next
		// appearance. Disable transition of top.
		this.visualNode.style.transition = "opacity 20ms";
		this.visualNode.style.top = "0%";
		// Hide the alien until it is ready to appear.
		this.visualNode.classList.add("hidden");
	}

	tick() {
		++this.ticks;
		if (this.ticks < 0) {
			return; // Waiting to appear.
		}
		if (this.ticks == 0) {
			this.visualNode.classList.remove("hidden");
			if (!this.isCommander) {
				// Move the alien down the screen, timing it to reach the bottom when it
				// should kill the player.
				this.visualNode.style.transition = `top ${length * 2 * ALIEN_TRIES}s, left 20ms, opacity 20ms`;
				this.visualNode.style.top = "90%";
			}
		}
		if (this.isCommander) {
			if (this.ticks == MAX_NOTE + 1) {
				// Commanders can't kill.
				this.reset();
				return;
			}
			if (this.ticks > 0) {
				++this.note;
			}
		} else if (this.ticks == ALIEN_TRIES) {
			// onAlienTick() will schedule a new tick after we return and killed()
			// calls suspend(). Therefore, killed() must run *after* onAlienTick()
			// returns.
			setTimeout(killed, 0);
			return;
		}
		this.play(this.freq);
		if (this.isCommander) {
			this.play(this.freq * 0.98);
			this.play(this.freq * 1.02);
		}
	}
}

function willAlienAppearNear(ticks) {
	for (let a = 0; a < maxAliens; ++a) {
		const alien = aliens[a];
		if (alien.ticks >= 0) {
			continue; // Already appeared.
		}
		if (Math.abs(alien.ticks - ticks) < 5) {
			return true;
		}
	}
	return false;
}

function getFurthestWaitingAlienTicks() {
	let min = 0;
	for (let a = 0; a < maxAliens; ++a) {
		const alien = aliens[a];
		if (alien.ticks >= 0) {
			continue; // Already appeared.
		}
		if (alien.ticks < min) {
			min = alien.ticks;
		}
	}
	return min;
}

function hasActiveCommander() {
	for (let a = 0; a < maxAliens; ++a) {
		if (aliens[a].isCommander) {
			return true;
		}
	}
	return false;
}

let player = new Entity();
// An array of Alien instances. This contains 4 instances throughout the game
// even if the maximum is lower for this level. maxAliens determines how many
// of these will be used.
let aliens;

function onPlayerTick() {
	if (continualTouchDir) {
		// The user is holding their finger on the left/right button on a touch
		// screen. We move multiple steps per tick.
		continualTouchDir.call(player, 4);
	}
	player.tick();
	pendingTick = setTimeout(onAlienTick, length * 1000);
}

function onAlienTick() {
	for (let a = 0; a < maxAliens; ++a) {
		aliens[a].tick();
	}
	pendingTick = setTimeout(onPlayerTick, length * 1000);
}

function suspend() {
	clearTimeout(pendingTick);
	pendingTick = null;
}

function resume() {
	setTimeout(onPlayerTick, 0);
}

function updateStatus() {
	statusArea.textContent = `Level ${level + 1}, ${lives} lives`;
	scoreArea.textContent = points;
}

async function nextLevel() {
	++level;
	hits = 0;
	commanders = 0;
	if (level == 1) {
		requiredHits = 30;
	} else if (level == 2) {
		requiredHits = 60;
	} else if (level == 3) {
		requiredHits = 100;
	}
	if (level <= 3) {
		++maxAliens;
		++maxCommanders;
	} else {
		length -= LEVEL_LENGTH_DECREMENT;
	}
	for (let a = 0; a < maxAliens; ++a) {
		aliens[a].reset();
	}
	// Since we're levelling up, show the status very prominently for a short time.
	// Moving the main status area disturbs the flow of the page, so we use
	// a dedicated, absolutely positioned element instead. We hide the main status
	// area while we show this.
	statusArea.classList.add("hidden");
	updateStatus();
	nextLevelArea.textContent = statusArea.textContent;
	nextLevelArea.classList.remove("hidden");
	suspend();
	await playSample("nextLevel");
	nextLevelArea.classList.add("hidden");
	statusArea.classList.remove("hidden");
	resume();
}

async function onFire() {
	if (!pendingTick) { // Suspended
		return;
	}
	if (playingFireSample) {
		playingFireSample.stop();
	}
	playingFireSample = playSample("fire");
	for (let a = 0; a < maxAliens; ++a) {
		let alien = aliens[a];
		if (player.note == alien.note && alien.ticks >= 0) {
			playSample("hit", { delay: 0.15, pan: alien.pan });
			const oldPoints = points;
			points += alien.isCommander ? maxAliens * 10 : maxAliens;
			++hits;
			if (alien.isCommander) {
				++totalCommandersHit;
			} else {
				++totalShipsHit;
			}
			alien.reset();
			if (Math.floor(points / POINTS_FOR_NEW_LIFE) >
					Math.floor(oldPoints / POINTS_FOR_NEW_LIFE) &&
					lives < MAX_LIVES) {
				++lives;
				updateStatus();
				playSample("newLife");
			}
			if (hits == requiredHits) {
				nextLevel();
			}
			break;
		}
	}
}

async function killed() {
	--lives;
	for (let alien of aliens) {
		alien.reset();
	}
	suspend();
	if (lives == 0) {
		await playSample("killed");
		gameOverMessageArea.textContent = `Game over! :( You reached level ${level + 1} with ${points} points. You hit ${totalShipsHit} ships and ${totalCommandersHit} commanders.`;
		gameArea.hidden = true;
		// Don't let the user dismiss this dialog too fast accidentally.
		startAgainButton.disabled = true;
		gameOverArea.hidden = false;
		gameOverArea.focus();
		await playSample("gameOver");
		setTimeout(stop, 500);
		return;
	}
	updateStatus();
	await playSample("killed");
	resume();
}

function announceScore() {
	announceArea.textContent = points;
	setTimeout(() => announceArea.textContent = "", 300);
}

gameArea.addEventListener("keydown", evt => {
	switch (evt.key) {
		case "ArrowLeft":
		case "ArrowDown":
			player.down();
			break;
		case "ArrowRight":
		case "ArrowUp":
			player.up();
			break;
		case " ":
			onFire();
			break;
		case "s":
			announceScore();
			break;
		default:
			return;
	}
	evt.preventDefault();
}, { capture: true });

function onLeftOrRightTouchStart(evt, dir) {
	dir.call(player);
	// If the user holds their finger down, trigger continual movement.
	continualTouchTimer = setTimeout(() => continualTouchDir = dir, 500);
	evt.preventDefault();
}

function onLeftOrRightTouchEnd(evt) {
	clearTimeout(continualTouchTimer);
	continualTouchTimer = null;
	continualTouchDir = null;
	evt.preventDefault();
}

leftButton.addEventListener("touchstart", evt =>
	onLeftOrRightTouchStart(evt, player.down));
leftButton.addEventListener("touchend", onLeftOrRightTouchEnd);
rightButton.addEventListener("touchstart", evt =>
	onLeftOrRightTouchStart(evt, player.up));
rightButton.addEventListener("touchend", onLeftOrRightTouchEnd);
fireButton.addEventListener("touchstart", evt => {
	onFire();
	evt.preventDefault();
});

/*
 * This function sets up and starts the game. The game then alternates
 * between onPlayerTick and onAlienTick using setTimeout. Most
 * events are processed immediately outside of a tick. Certain events might
 * temporarily suspend() and resume() the ticks.
 */
async function start() {
	introArea.hidden = true;
	gameOverArea.hidden = true;
	gameArea.hidden = false;
	gameArea.focus();
	player.note = MAX_NOTE / 2;
	aliens = [
		// Pan the four possible aliens across the stereo field.
		new Alien(-0.8),
		new Alien(0.8),
		new Alien(-0.4),
		new Alien(0.4)
	];
	maxAliens = 1;
	level = 0;
	length = BASE_LENGTH;
	requiredHits = 10;
	maxCommanders = 1;
	commanders = 0;
	lives = 3;
	hits = 0;
	points = 0;
	totalShipsHit = 0;
	totalCommandersHit = 0;
	aliens[0].reset();
	audioCtx.resume();
	updateStatus();
	setTimeout(onPlayerTick, 100);
}

function stop() {
	clearTimeout(pendingTick);
	startAgainButton.disabled = false;
}

async function init() {
	// Add cells to our visual area, one for each note. This draws visible
	// rectangles in which the players and aliens will later appear.
	for (let c = 0; c <= MAX_NOTE; ++c) {
		const cell = document.createElement("div");
		cell.className = "cell";
		visualArea.append(cell);
	}
	let promises = [];
	for (const name of
			["fire", "gameOver", "hit", "killed", "newLife", "nextLevel"]) {
		promises.push(loadSample(name));
	}
	await Promise.all(promises);
	startButton.disabled = false;
}

init();
</script>
</body>
</html>
